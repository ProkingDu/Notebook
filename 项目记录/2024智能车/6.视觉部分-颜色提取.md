
## 业务记录

赛项中需要有避障的部分，这里需要通过颜色提取来确定障碍物，障碍物的颜色是蓝色的，形状是一个锥桶。

颜色提取的思路和之前机械狗的思路一样，通过检测HSV阈值、创建掩膜、寻找轮廓来确定障碍物。


首先是提取掩膜：
```python
import cv2
import numpy as np


lower_blue = np.array([90, 50, 50])
upper_blue = np.array([130, 255, 255])

"""
检测颜色
img : 原始的BGR图像
Todo 如果后续针对HSV检测较多的话把这里参数改成HSV格式来减少运算量。
"""
def detect_color(img,color_min,color_max):
    # 转换颜色空间
    hsv_img = cv2.cvtColor(img,cv2.COLOR_BGR2HSV)
    
    # 检测颜色阈值，创建掩膜
    mask = cv2.inRange(hsv_img,color_min,color_max)
    
    # 展示掩膜图像
    cv2.imshow("mask",mask)
    

if __name__ == "__main__":
    cap = cv2.VideoCapture(0)
    if cap.isOpened:
        while True:
            ret,img = cap.read()
            
            # 对图像进行必要的裁剪
            img = cv2.resize(img,(640,480))
            img = img[int(img.shape[0]/2):,int(img.shape[1]/3):int(img.shape[1]/1.5)]
            cv2.imshow("raw",img)
            detect_color(img,lower_blue,upper_blue)
            if cv2.waitKey(10) == ord('q'):
	            break
```

![小杜的个人图床](http://src.xiaodu0.com/2024/09/27/8278558e6fde0767266831c91e92208c.png)


看到掩膜中有很多杂乱的小物体被识别到，接下来通过形态学操作来去除噪声。根据形态学操作的几个基本运算，开运算的特点是先腐蚀再膨胀，这里的腐蚀就是通过一个结构元素（也称为核）来减少图像中前景（通常是白色或高亮度）像素的大小。而在腐蚀之后，原先较大的物体也会被减小，因此要通过膨胀使其恢复原先的大小。所以这里要清除噪声就是去除小物体，使用开运算。

```python
k = np.array([3,3],dtype=np.uint8)
mask = cv2.morphologyEx(mask,cv2.MORPH_OPEN,k)
```

调整后：

![小杜的个人图床](http://src.xiaodu0.com/2024/09/27/72ede8202df7d1b3f4b1fad4dc1b4ffd.png)


到这里还有一些小的噪声，接下来通过提取轮廓来过滤小的噪声，提取最大的物体也就是避障所用的锥桶。

```python

```
## 扩展记录

### cv2.morphologyEx

cv2.morphologyEx用于对图像进行形态学操作。如开运算、闭运算、梯度、顶帽和黑帽等。
‘
**形态学操作主要用于图像处理中的去噪、分割和特征提取等任务。**

形态学操作基于集合论的概念，通过一个结构元素（通常称为“核”或“内核”）与图像中的像素进行交互，从而改变图像中的像素值。常用的操作包括：

- **开运算** (`MORPH_OPEN`)：先腐蚀再膨胀，**主要用于去除小物体。**
- **闭运算** (`MORPH_CLOSE`)：先膨胀再腐蚀，**主要用于填补小孔洞。**
- **梯度** (`MORPH_GRADIENT`)：膨胀减去腐蚀的结果，**主要用于边缘检测。**
- **顶帽** (`MORPH_TOPHAT`)：原图像减去开运算的结果，**主要用于增强亮区域。**
- **黑帽** (`MORPH_BLACKHAT`)：闭运算减去原图像的结果，**主要用于增强暗区域。**

函数语法：
```
cv2.morphologyEx(src, op, kernel[, dst[, anchor[, iterations[, borderType[, borderValue]]]]])
```

**参数：**

- **`src`**：输入图像。
- **`op`**：指定的形态学操作类型，如 `cv2.MORPH_OPEN`、`cv2.MORPH_CLOSE` 等。
- **`kernel`**：用于操作的核（结构元素）。
- **`dst`**：可选参数，输出图像。
- **`anchor`**：可选参数，默认为核的中心位置。指定核的锚点位置。
- **`iterations`**：可选参数，默认为 1。指定形态学操作的迭代次数。
- **`borderType`**：可选参数，默认为 `cv2.BORDER_CONSTANT`。指定边界处理类型。
- **`borderValue`**：可选参数，默认为黑色（0）。指定边界填充值。

