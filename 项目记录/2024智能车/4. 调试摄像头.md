

车身有两个摄像头，一个是云台摄像头，一个是车头上的摄像头，其中云台摄像头通过pwm总线连接GPIO针脚，车头摄像头通过USB接口连接开发板。

这里先调试下车头摄像头，车头上的摄像头因为是直接通过USB连接的，可以通过查询/dev目录下的设备来查看编号：
```python
ls /dev
```

![小杜的个人图床](http://src.xiaodu0.com/2024/09/23/df8fa4cdf2dc70d717d412947ee10597.png)

然后这里还没有安装opencv，需要编译安装。



安装依赖：
```bash
sudo apt-get install build-essential git cmake pkg-config -y
sudo apt-get install libjpeg8-dev -y
sudo apt-get install libtiff5-dev -y
sudo apt-get install libjasper-dev -y
sudo apt-get install libpng12-dev -y
sudo apt-get install libavcodec-dev libavformat-dev libswscale-dev libv4l-dev -y
sudo apt-get install libgtk2.0-dev -y
sudo apt-get install libatlas-base-dev gfortran -y
```

下载opencv源码和opencv-contri：
```bash
wget -O opencv-4.2.0.zip https://github.com/opencv/opencv/archive/4.2.0.zip
wget -O opencv_contrib-4.2.0.zip https://codeload.github.com/opencv/opencv_contrib/zip/4.2.0
```

编译：
```python
cd download
unzip opencv-4.2.0.zip
cd opencv-4.2.0
mkdir build
cd build
sudo cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=/usr/local -D OPENCV_EXTRA_MODULES_PATH=/home/proking/workspaceDfy/down
load/opencv_contrib-4.2.0/modules -D INSTALL_PYTHON_EXAMPLES=ON -D INSTALL_CXX_EXAMPLES=ON -D BUILD_EXAMPLES=OFF ..
sudo make
```

这里要注意改：
```python
OPENCV_EXTRA_MODULES_PATH=/home/proking/workspaceDfy/download/opencv_contrib-4.2.0/modules
```
指定opencv_contrib的路径。

编译完用python导入cv2一直提示找不到模块，各种解决办法都尝试了仍然无济于事，这里卡了好久最后无奈直接下载轮子上传到树莓派然后pip3安装。。。

然后解决依赖缺失的问题。

报错：
```python
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/home/proking/.local/lib/python3.7/site-packages/cv2/__init__.py", line 3, in <module>
    from .cv2 import *
ImportError: libhdf5_serial.so.103: cannot open shared object file: No such file or directory
```

安装libhdf5-dev：
```python
sudo apt-get update
sudo apt-get install libhdf5-dev
```

报错：
```python
Traceback (most recent call last):
  File "video_finder.py", line 5, in <module>
    import cv2
  File "/home/proking/.local/lib/python3.7/site-packages/cv2/__init__.py", line 3, in <module>
    from .cv2 import *
ImportError: libjasper.so.1: cannot open shared object file: No such file or directory
```

安装libjasper-dev：

```bash
sudo apt-get install libjasper-dev
```

报错：
```python
Traceback (most recent call last):
  File "video_finder.py", line 5, in <module>
    import cv2
  File "/home/proking/.local/lib/python3.7/site-packages/cv2/__init__.py", line 3, in <module>
    from .cv2 import *
ImportError: libImath-2_2.so.23: cannot open shared object file: No such file or directory
```

安装libopenexr-dev：
```bash
sudo apt-get install libopenexr-dev
```

报错：
```python
Traceback (most recent call last):
  File "video_finder.py", line 5, in <module>
    import cv2
  File "/home/proking/.local/lib/python3.7/site-packages/cv2/__init__.py", line 3, in <module>
    from .cv2 import *
ImportError: libQtGui.so.4: cannot open shared object file: No such file or directory
```

安装：
```
sudo apt-get install libqtgui4
```

报错：
```python
Traceback (most recent call last):
  File "video_finder.py", line 5, in <module>
    import cv2
  File "/home/proking/.local/lib/python3.7/site-packages/cv2/__init__.py", line 3, in <module>
    from .cv2 import *
ImportError: libQtTest.so.4: cannot open shared object file: No such file or directory
```

安装：
```
sudo apt-get install libqt4-test
```

报错：
```python
Traceback (most recent call last):
  File "video_finder.py", line 5, in <module>
    import cv2
  File "/home/proking/.local/lib/python3.7/site-packages/cv2/__init__.py", line 3, in <module>
    from .cv2 import *
ImportError: /home/proking/.local/lib/python3.7/site-packages/cv2/cv2.cpython-37m-arm-linux-gnueabihf.so: undefined symbol: __atomic_fetch_add_8
```

安装：
```
sudo apt-get install libatomic1
```

后面还有各种各样奇奇怪怪的问题 没有一个个记录。辗转反侧也是安装好了。


安装完opencv之后，简单写一些查询摄像头编号的demo：
```python
"""
寻找启用的摄像头
"""

import cv2
import time
import numpy as np

caps = []
for i in range(21):
    tmp = cv2.VideoCapture(i)
    if tmp.isOpened():
        caps.append(i)

print(caps)
```

这里输出：
![小杜的个人图床](http://src.xiaodu0.com/2024/09/25/887f4fbb4495773e38451c166584e714.png)


0、14、15是启用的摄像头，然后挨个打开查看一下：
```python
import cv2

cam_id = 0

cap = cv2.VideoCapture(cam_id)

if cap.isOpened():
    while True:
        ret,frame = cap.read()
        if ret:
            cv2.imshow(f"cap{cap}",frame)
        if cv2.waitKey(1) == ord("q"):
            break

cv2.destoryAllWindows()
```

这个自带高斯滤波效果的摄像头是车头上的“1080P高清摄像头“，编号是0.


![小杜的个人图床](http://src.xiaodu0.com/2024/09/25/8f59e77a2fec226ec4a3e729e8077f32.png)


然后云台上的摄像头比较特殊，他是CSI摄像头，相比车头的USB摄像头能够直接读取，CSI摄像头需要做些配置工作。

首先要打开摄像头作为支持
```
sudo raspi-config
```

在配置界面中选择"Interfacing Options"（接口选项），然后选择"Camera"（摄像头），按照提示启用相机。

**Advanced Options**选择**Expand Filesystem**，将根目录扩展到这个SD卡，充分利用SD卡的存储空间。如果不进行这一步，后续命令会出现卡死。退出设置界面，重启树莓派。

然后我经过一系列操作之后仍然无法读取到摄像头的数据，直到我起来看了一眼摄像头：
![小杜的个人图床](http://src.xiaodu0.com/2024/09/25/efb0f1d4ca747e3c3c30daf1927fed0b.jpg)

![小杜的个人图床](http://src.xiaodu0.com/2024/09/25/87e5dcc7d76eef553e0bca7558c1ef41.jpg)


没接供电。。。。


接上供电之后，再扫一下摄像头，这个CSI摄像头的编号是2：
![小杜的个人图床](http://src.xiaodu0.com/2024/09/25/f82cef5c8840606d4406f9809185c53f.png)

然后记录下调试之后的接线：
![小杜的个人图床](http://src.xiaodu0.com/2024/09/25/4161f1b68110d2b5c620e7a563df9e55.jpg)



接下来就可以装车了。