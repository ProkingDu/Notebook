
## 概述

局部异常因子（Local Outlier Factor, LOF）是用于异常检测的一种算法，特别适用于检测数据集中局部密度不同的异常点。其核心思想是**通过比较一个样本点的局部密度与其邻近样本的局部密度来检测样本点是否为异常样本点。**
一般认为指定数据点的局部密度显著低于其临近样本的局部密度可以被视作异常样本点。

局部密度（也称局部可达密度）由样本点的k-邻近距离与邻居数量得出，与KNN（k-邻近算法）类似，LOF通过计算样本点距离来确定邻居，因此在了解LOF之前需要了解他的几个基本概念。

## LOF基本概念

在LOF中有四个基本概念，分别是：K-邻近距离、k-距离领域、k-可达距离、k-局部可达密度。

### K邻近距离

k-邻近距离指在样本空间中，一个样本点P与其最近的第k的样本点的距离，记作$d_k(P)$ 。
例如，第$d_{1}(p)$表示样本P距离其最近的第一个样本的距离。
k-邻近距离可以使用多种方式度量，通常使用欧式距离进行度量。
> 欧氏距离： 在平面坐标系中两点之间的线段长度。
> $d(P,Q)=\sqrt{(x2​−x1​)^2+(y2​−y1​)^2}​$
> 
> 在三维空间中，如果点 P=(x1,y1,z1)P=(x1​,y1​,z1​) 和 Q=(x2,y2,z2)，则欧氏距离为：
> 
> $d(P, Q) = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2 + (z_2 - z_1)^2}​$

例如根据样本数据的分布构建散点图，在散点图中的样本点P的坐标到其第k个最近样本点的距离可以通过P的位置与第k个邻近样本点的位置来计算其k-邻近距离。

### K-距离领域

以P点为圆心$d_{k}(p)$为半径的领域， 表示为$N_{k}(P)$ 。
例如，在样本空间中，$N_{3}(P)$表示以P点为圆心，P点与其最近的第三个邻居的距离作为半径的领域。

![小杜的个人图床](http://src.xiaodu0.com/2024/08/12/669f6a62cde64211999cb366c8d1652b.png)


如上图所示，中心点为P点，选择第K个最近邻居的k邻近距离作为半径，蓝色部分标注即为K距离领域$N_d(P)$。

### k-可达距离

k-可达距离有两种可能的取值，在定义上，样本点P到样本点O的k-可达距离为$d_{k}(O)$或者P与O的欧氏距离两者的较大值。
表示为：
$$
reach\_dist_k(P,O)=max{dk(O),d(P,O)}
$$

直观来看，对于一个样本点P到样本点O的可达距离可以通过O的k-距离领域来表示，当P在O的k-距离领域中时，表明P到O的距离小于O的k-距离领域（即O的邻近第K个样本点的k-邻近距离）所以此时以$d_{k}(O)$为k-可达距离。
同理，当P在$N_{k}(O)$之外时，$d(P,O)>d_{k}(O)$ 因此以$d(P,O)$作为k-可达距离
![小杜的个人图床](http://src.xiaodu0.com/2024/08/12/f5470ceeae35bb672ae7403aed6aa80a.png)

如上图所示，P点在$N_{d}(O)$之外，则取$d(P,O)$作为k-可达距离。

### k-局部可达密度

k-局部可达密度（local reachability density, lrd）即为样本点P在第k个距离邻域内的累计k-可达距离与距离区域内样本点数的比值的倒数，记作$lrd_{d}(P)$

计算公式为：
$$
lrd_{k}(P) = \left( \frac{\sum{rich\_{dist}_{k}(P)}}{|N_{k}(P)|}  \right)^{-1}
$$

公式意义为，计算$N_{k}(P)$ 中 所有样本点O与P的可达距离，除以邻域内样本点的数量得到平均值，随后取倒数来表示在$N_{k}(P)$ 的k-局部可达密度。

当P到每个临近点的平均距离（分子）越小，密度越大，P到每个临近点的平均距离越大，密度越小。

如果对于所有的邻近点O都在$N_{k}(P)$内，k-可达距离可以简化为k-临近距离，即：
$$
lrd_{k}(P) = \left(\frac {\sum d_{k}(P)}{|N_{k}(P)|}\right)^{-1}
$$

## k-局部异常因子

基于以上四个基本概念提出K-局部异常因子的计算，局部异常因子是对样本点进行判断的直接标准。

K-局部异常因子（Local Outlier Factor）的计算公式是：
$$
LOF_{k}(P)=\frac{\frac{1}{|N_{k}(P)|}\sum_{O\in N_{k}(P)}lrd_{k}(O)}{lrd_k(P)}
$$

即对P领域内每个样本点O计算其局部可达密度乘以P的距离领域内的样本点数量的倒数，也就是P的k-距离邻域内的样本点的平均局部可达密度与点P的局部可达密度的比值。

由公式可以推导：
当$lrd_{k}(P) \geq {\frac{1}{|N_{k}(P)|}\sum_{O\in N_{k}(P)}lrd_{k}(O)}$时，即$LOF_{k}(P) \leq 1$ ，即P的局部可达密度较大，认为P是正常数据点。

当$lrd_{k}(P)<{\frac{1}{|N_{k}(P)|}\sum_{O\in N_{k}(P)}lrd_{k}(O)}$  时，即$LOF_{k}(P) > 1$，说明$lrd_{k}(P)$较小，认为P是异常数据点。

## 关于K值

由以上各种局部异常因子算法中的基本指标可以看出，k值对局部异常的检测起决定性的作用，因为选择适当的K值是LOF算法能够起到精准的预测功能的前提。



$$
lrd_{k}(P) = \left( \frac{\sum{rich\_{dist}_{k}(P)}}{|N_{k}(P)|}  \right)^{-1}
$$

以上是局部密度估计的计算公式，在公式中K值代表对P值的局部密度计算选择的样本点，K值越大，选择的邻近样本点越多，则lrd对局部数据的敏感程度更低。
同理，当K值更小时，选择参数估计的样本点更少，则样本点的微小变动会对公式中分子总体也就是局部可达距离的和产生较大变化率，同时会较大的影响lrd，使得其对于局部数据更敏感。

综上所述：
1. **较大的k值有助于降低噪声数据的影响，降低对正常样本点的误判率，但是可能会降低对真正异常数据的敏感程度。同时较大的K值会导致对异常样本点的影响平均化。**
2. **较小的k值会使数据点对局部数据更加敏感，能够提高对异常点的检测率，但是同时也会提高对正常样本的误判率。同时会使对异常点的检测受噪声影响更大**


通常， k 值的选择需要在检测精度和稳健性之间找到平衡。一个常见的做法是尝试不同的 k 值，并观察结果的变化。**在实践中， k 值的选择通常在数据集大小的 1% 到 5% 之间，但具体的选择依赖于数据集的特性和具体的应用场景。**



总的来说：
1. **调大K值：对全局数据更加敏感，降低受噪声影响**
2. **减小K值：对局部数据更加敏感，容易受噪声影响。**

因此，在调整K值时需要根据异常检测对象的特性来确定是增加还是减少。

例如周期波动的时间序列数据，例如每周的每天电影院票房，更加关注局部数据，则应当调小K值。
例如全年的粮价数据，应当在使用较大的K值，考虑全局数据。

### LOF的Python实现

